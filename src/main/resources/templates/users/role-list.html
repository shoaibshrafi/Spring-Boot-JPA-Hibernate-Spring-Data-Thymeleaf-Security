<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
		xmlns:th="http://www.thymeleaf.org"
      	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      	layout:decorate="~{template1/template}">

<th:block layout:fragment="page_title">Role List</th:block>

<div layout:fragment="page_content">

	<div class="row" id="role-list-component">
		<role-form :show="showRoleForm" :role-code="editRoleCode" @close="showRoleForm = false" @created="roleAdded"></role-form>
		<role-privileges-form :show="showRolePrivilegesForm" :role-code="editRolePrivilegesCode" @close="showRolePrivilegesForm = false"></role-privileges-form>
		<div class="col-12">
            <div class="card">
            	<div class="card-header">
                	<h3 class="card-title">Roles</h3>
					<div class="card-tools">
						<button type="button" class="btn btn-block btn-outline-primary btn-xs" @click="addNewRole">Add New Role</button>
            		</div>              	
              	</div>
              	<!-- /.card-header -->
              	<div class="card-body">
              		<div class="row mb-3">
	                	<div class="col-6">
							<div class="input-group">
	                  			<div class="input-group-append">
	                    			<div class="btn btn-default">
	                      				<i class="fas fa-search"></i>
	                    			</div>
	                  			</div>
	                  			<input type="text" name="search" class="form-control" placeholder="Search By Role Code, Role Name" v-model="filters.search">
	                		</div>
						</div>
              		</div>
              		
                	<table class="table table-bordered table-hover">
                  		<thead>
                  			<tr>
                    			<th>Code</th>
			                    <th>Name</th>
			                    <th>Admin</th>
			                    <th>Created By</th>
			                    <th>Created On</th>
			                    <th>Action</th>
		                  </tr>
	                  	</thead>
   	              		<tbody>
   	              			<tr v-if="loading">
   	              				<td colspan="6">
	   	              				<div class="alert alert-info alert-dismissible">
	                					<h4><i class="icon fas fa-spinner fa-spin"></i> Loading, Please Wait...</h4>
	              					</div>
   	              				</td>
   	              			</tr>
   	              			<tr v-if="count == 0" v-cloak>
   	              				<td colspan="6">
	   	              				<div class="alert alert-warning">
	                					<h5><i class="icon fas fa-exclamation-triangle"></i> Sorry</h5>
	                					No record found
	              					</div>
   	              				</td>
   	              			</tr>
   	              		
							<tr v-if="!loading && !error" v-for="d in data">
		                    	<td>{{d.roleCode}}</td>
		                    	<td>{{d.roleName}}</td>
								<td><span class="badge bg-success" v-if="d.admin">Admin</span></td>
		                    	<td>{{d.createdBy}}</td>
		                    	<td>{{d.createdDate | formatDateTime}}</td>
		                    	<td class="text-center">
			                          <a class="btn btn-primary btn-sm" href="javascript:void(0)" @click="editRole(d.roleCode)"><i class="fas fa-edit"></i> Edit</a>
			                          <button class="btn btn-danger btn-sm" @click="deleteRole(d.roleCode)" :disabled="processingDeleteCode == d.roleCode"><i class="fas fa-trash"></i> 
			                          	<template v-if="processingDeleteCode == d.roleCode">Deleting...</template>
			                          	<template v-else>Delete</template>
			                          </button>
			                          <a v-if="!d.admin" class="btn btn-default btn-sm" href="javascript:void(0)" @click="assignPrivileges(d.roleCode)"><i class="fas fa-trash"></i> Privileges</a>
		                    	</td>
		                  	</tr>
						</tbody>
					</table>
				</div>
				<div class="card-footer clearfix">
					<div class="dataTables_info">Showing {{currentPageStart}} to {{currentPageEnd}} of {{count}} records</div>
					<div class="float-right">
				        <pagination :total-rows="count" :max-pages="3" :current-page="pagination.currentPage" :page-size="pagination.pageSize" @changed="paginationHandler"></pagination>
					</div>
				</div>
 				
				
			</div>
		</div>
	</div>
</div>

<th:block layout:fragment="scripts">
	
	<div th:include="vue-components/users/role-add::template"></div>
	<div th:include="vue-components/users/role-add::scripts"></div>
	
	<div th:include="vue-components/users/role-privileges::template"></div>
	<div th:include="vue-components/users/role-privileges::scripts"></div>

	<script th:src="@{/js/pagination/pagination.js}"></script>
	
	<script type="text/javascript">
	new Vue({
		  el: '#role-list-component',
		  data: {
		    	loading: false,
		    	error: false,
		    	data: [],
		    	count: 0,
		    	filters:{
		    		search: '',
		    		roleCode: ''
		    	},
		    	pagination: {
		    		currentPage: 1,
		    		pageSize: 10
		    	},
		    	showRoleForm: false,
		    	editRoleCode: '',
		    	processingDeleteCode: '',
		    	showRolePrivilegesForm: false,
		    	editRolePrivilegesCode: ''
		  },
		  created: function(){
			  this.loadData();
		  },
		  computed: {
              currentPageStart: function(){
                  return (this.pagination.currentPage - 1) * this.pagination.pageSize + Math.min(1,this.count);
              },
              currentPageEnd: function(){
                  return Math.min((this.currentPageStart+this.pagination.pageSize-1), this.count);
              },
  
		  },
		  watch: {
			  filters: {
				  handler: function(newVal){
					  this.loadData();
				  },
				  deep: true
			  }
		  },
		  methods: {
				
			  paginationHandler: function(pageNo){
				  this.pagination.pageNo = pageNo;
				  this.loadData();
			  },
			  
			  loadData: function(){
				
				this.loading = true;
				this.error = false;
					
				var params = {};
					
				params['pageNo'] = this.pagination.pageNo;
				params['pageSize'] = this.pagination.pageSize;
				
				$.each(this.filters, function(key, value){
					if(value){
						params[key] = value;
					}
				});
				
				var that = this;
				
				$.getJSON( appContext + "api/roles", params, function( data ) {
					  that.data = data.data;
					  that.count = data.count;
					  that.loading = false;
					  that.error = false;
				}).fail(function(response){
					 alert(response); 
					 console.log(response)
					  that.loading = false;
					  that.error = true;
				});
				
			  },
			  addNewRole: function(){
				  this.editRoleCode = '';
				  this.showRoleForm = true;
			  },
			  roleAdded: function(roleCode){
				  this.showRoleForm = false; 
				  this.loadData()
			  },
			  editRole: function(roleCode){
				  this.editRoleCode = roleCode;
				  this.showRoleForm = true;
			  },
			  deleteRole: function(roleCode){
				  var that = this;
				  js_confirm({
					  title : "Delete Role",
					  text: "Are you sure, you want to delete this role?",
					  okLabel: "Yes, Delete it",
					  cancelLabel: "Cancel",
					  ok: function(){
						  that.processingDeleteCode = roleCode;
						  $.ajax({ url: appContext + 'api/roles/' + roleCode, method: "DELETE" })
				            .then(function (data) {
								showSuccessMessage("Role deleted successfully");
								that.loadData();
				            })
				            .catch(function (err) {
				            	showErrorFromResponse(err);
								that.processingDeleteCode = '';
				            });					  
						}
				  })
			  },
			  assignPrivileges: function(roleCode){
				  this.editRolePrivilegesCode = roleCode;
				  this.showRolePrivilegesForm = true;
			  }
		  }
	});
	
	</script>
	
	
</th:block>

</html>